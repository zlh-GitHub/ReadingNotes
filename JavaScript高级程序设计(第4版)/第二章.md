## 2.1 `<script>` 元素

`<script>` 元素有下列8个属性:

* async: 可选。表示应该立即开始下载脚本，但不能阻止其他页面动作，比如下载资源或等其他脚本加载。只对外部本文件有效。
* charset: 可选。使用 src 属性指定的代码字符集。这个属性很少使用，因为大多数浏览器不在乎它的值。
* crossorigin: 可选。配置相关请求的 CORS(跨源资源共享)设置。默认不使用 CORS。crossorigin= "anonymous"配置文件请求不必设置凭据标志。crossorigin="use-credentials"设置凭据标志，意味着出站请求会包含凭据。
* defer: 可选。表示脚本可以延迟到文档完全被解析和显示之后再执行。只对外部本文件有效。 在 IE7 及更早的版本中，对行内脚本也可以指定这个属性。
* integrity: 可选。允许比对接收到的资源和指定的加密签名以验证子资源完整性(SRI，Subresource Integrity)。如果接收到的资源的签名与这个属性指定的签名不匹配，则页面会报错，脚本不会执行。这个属性可以用于确保内容分发网络(CDN，Content Delivery Network)不会提供恶意内容。
* language: 废弃。最初用于表示代码块中的脚本语言(如"JavaScript"、"JavaScript 1.2"
或"VBScript")。大多数浏览器都会忽略这个属性，不应该再使用它。
* src: 可选。表示包含要执行的代码的外部文件。
* type: 可选。代替 language，表示代码块中脚本语言的内容类型(也称 MIME 类型)。按照惯例，这个值始终都是 "text/javascript"，尽管 "text/javascript" 和 "text/ecmascript" 都已经废弃了。JavaScript 文件的 MIME 类型通常是"application/x-javascript"，不过给 type 属性这个值有可能导致脚本被忽略。在非 IE 的浏览器中有效的其他值还有 "application/javascript" 和 "application/ecmascript"。如果这个值是 module，则代码会被当成 ES6 模块，而且只有这时候代码中才能出现 import 和 export 关键字。

在 `<script>` 元素中的代码（包括 src 引用的外部 JavaScript 文件）被计算完成之前，页面的其余内容不会被加载，也不会被显示。（tips：阻塞时间包括下载文件的时间）

在使用行内 JavaScript 代码时，要注意代码中不能出现字符串 `</script>`，如要使用可以使用转义字符，如 `<\/script>`，否则会导致浏览器报错。

> 按照惯例，外部 JavaScript 文件的扩展名是.js。这不是必需的，因为浏览器不会检查所包含 JavaScript 文件的扩展名。这就为使用服务器端脚本语言动态生成 JavaScript 代码，或者在浏览器中将 JavaScript 扩展语言(如 TypeScript，或 React 的 JSX)转译为 JavaScript 提供了可能性。不过要注意，服务器经常会根据文件扩展来确定响应的正确 MIME 类型。 如果不打算使用.js 扩展名，一定要确保服务器能返回正确的 MIME 类型。

使用了 src 属性的 `<script>` 元素不应该再在 `<script>` 和 `</script>` 标签中再包含其他 JavaScript 代码。如果两者都提供的话，则浏览器只会下载并执行脚本文件，从而忽略行内代码。

`<script>` 元素的一个最为强大、同时也备受争议的特性是，它可以包含来自外部域的 JavaScript 文件。这个能力可以让我们通过不同的域分发 JavaScript。浏览器在解析这个资源时，会向 src 属性指定的路径发送一个 GET 请求，以取得相应资源，假定是一个 JavaScript 文件。这个初始的请求不受浏览器同源策略限制，但返回并被执行的 JavaScript 则受限制。当然，这个请求仍然受父页面 HTTP/HTTPS 协议的限制

> 在包含外部域的 JavaScript 文件时，要确保该域是自己所有的，或者该域是一个可信的来源。`<script>` 标签的 integrity 属性是防范这种问题的一个武器，但这个属性也不是所有浏览器都支持。

> 不管包含的是什么代码，浏览器都会按照 `<script>` 在页面中出现的顺序依次解释它们，前提是它们没有使用 defer 和 async 属性。

### 2.1.1 标签位置

把所有 JavaScript 文件都放在 `<head>`里，意味着必须把所有 JavaScript 代码都下载、解析和解释完成后，才能开始渲染页面(页面在浏览器解析到 `<body>` 的起始标签时开始渲染)。对于需要很多 JavaScript 的页面，这会 导致页面渲染的明显延迟，在此期间浏览器窗口完全空白。为解决这个问题，现代 Web 应用程序通常将所有 JavaScript 引用放在 `<body>` 元素中的页面内容后面

### 2.1.2 推迟执行脚本 defer

HTML 4.01 为 `<script>` 元素定义了一个叫 defer 的属性。这个属性表示脚本在执行的时候不会改变页面的结构。也就是说，脚本会被延迟到整个页面都解析完毕后再运行。因此，在 `<script>` 元素上设置 defer 属性，相当于告诉浏览器立即下载，但延迟执行。

```html
<!DOCTYPE html> 
<html> 
  <head> 
  <title>Example HTML Page</title> 
  <script defer src="example1.js"></script> 
  <script defer src="example2.js"></script> 
  </head> 
  <body> 
  <!-- 这里是页面内容 --> 
  </body> 
</html>
```

虽然这个例子中的 `<script>` 元素包含在页面的 `<head>` 中，但它们会在浏览器解析到结束的 `</html>` 标签后才会执行。HTML5 规范要求脚本应该按照它们出现的顺序执行，因此第一个推迟的脚本会在第二个推迟的脚本之前执行，而且两者都会在 DOMContentLoaded 事件之前执行(关于事件，请参考第 17 章)。不过在实际当中，推迟执行的脚本不一定总会按顺序执行或者在 DOMContentLoaded 事件之前执行，因此最好只包含一个这样的脚本。

> 对 defer 属性的支持是从 IE4、Firefox 3.5、Safari 5 和 Chrome 7 开始的。其他所有浏览器则会忽略这个属性，按照通常的做法来处理脚本。考虑到这一点，还是把要推迟执行的脚本放在页面底部比较好。

> 注意 对于XHTML文档，指定defer属性时应该写成defer="defer"。

### 2.1.3 异步执行脚本 async

与 defer 一样，都只适用于外部脚本，但不同的是，标记为 async 的脚本并不保证能按照它们出现的次序执行。

给脚本添加 async 属性的目的是告诉浏览器，不必等脚本下载和执行完后再加载页面，同样也不必等到该异步脚本下载和执行后再加载其他脚本。正因为如此，异步脚本不应该在加载期间修改 DOM。

> 注意 对于XHTML文档，指定async属性时应该写成async="async"。

### 2.1.4 动态加载脚本

```js
let script = document.createElement('script'); 
script.src = 'gibberish.js'; 
document.head.appendChild(script);
```

默认情况下， 以这种方式创建的 `<script>` 元素是以异步方式加载的，相当于添加了 async 属性。不过这样做可能会有问题，因为所有浏览器都支持 createElement()方法，但不是所有浏览器都支持 async 属性。因此，如果要统一动态脚本的加载行为，可以明确将其设置为同步加载:

```js
let script = document.createElement('script'); 
script.src = 'gibberish.js';
script.async = false;
document.head.appendChild(script);
```

以这种方式获取的资源对浏览器预加载器是不可见的。这会严重影响它们在资源获取队列中的优先级。根据应用程序的工作方式以及怎么使用，这种方式可能会严重影响性能。要想让预加载器知道这些动态请求文件的存在，可以在文档头部显式声明它们: 

```js
<link rel="preload" href="gibberish.js" />
```

### 2.1.5 XHTML 中的变化

可扩展超文本标记语言(XHTML，Extensible HyperText Markup Language)是将 HTML 作为 XML 的应用重新包装的结果。与 HTML 不同，在 XHTML 中使用 JavaScript 必须指定 type 属性且值为 text/javascript，HTML 中则可以没有这个属性。

XHTML 中编写代码的规则比 HTML 中严格，这会影响使用 `<script>` 元素嵌入 JavaScript 代码。如
`a < b` 中的小于号会被解释成一个标签的开始，并且由于作为标签开始的小于号不能有空格，所以这会导致语法错误。解决方案如下

1. 第一种是把所有小于号（<）都替换成对应的 HTML 实体形式（&lt;），即 `a &lt; b`
2. 把所有代码都包含到一个 CDATA 块中。在 XHTML（及 XML）中，CDATA 块表示
文档中可以包含任意文本的区块，其内容不作为标签来解析，因此可以在其中包含任意字符，包括小于
号，并且不会引发语法错误。

```js
<script type="text/javascript"><![CDATA[ 
function compare(a, b) { 
  if (a < b) { 
    console.log("A is less than B"); 
  } else if (a > b) { 
    console.log("A is greater than B"); 
  } else { 
    console.log("A is equal to B"); 
  } 
} 
]]></script>
```

在兼容 XHTML 的浏览器中，这样能解决问题。但在不支持 CDATA 块的非 XHTML 兼容浏览器中则不行。为此，CDATA 标记必须使用 JavaScript 注释来抵消

```js
<script type="text/javascript"> 
//<![CDATA[ 
function compare(a, b) { 
  if (a < b) { 
    console.log("A is less than B"); 
  } else if (a > b) { 
    console.log("A is greater than B"); 
  } else { 
    console.log("A is equal to B"); 
  } 
} 
//]]> 
</script>
```

这种格式适用于所有现代浏览器。虽然有点黑መ技的։道，但它可以通过 XHTML 验证，而且对
XHTML 之前的浏览器也能优雅地降级。

> 注意 XHTML 模式会在页面的 MIME 类型被指定为"application/xhtml+xml"时触 发。并不是所有浏览器都支持以这种方式送达的 XHTML。

### 2.1.6 废弃的语法

type 属性使用一个 MIME 类型字符串来标识 `<script>` 的内容，但 MIME 类型并没有跨浏览器标准化。即使浏览器默认使用 JavaScript，在某些情况下某个无效或无法识别的 MIME 类型也可能导致浏览器跳过(不执行) 相关代码。因此，除非你使用 XHTML 或 `<script>` 标签要求或包含非 JavaScript 代码，最佳做法是不指定 type 属性。

在最初采用 script 元素时，它标志着开始走向与传统 HTML 解析不同的流程。对这个元素需要应用特殊的解析规则，而这在不支持 JavaScript 的浏览器(特别是 Mosaic)中会导致问题。不支持的浏览器会把 `<script>` 元素的内容输出到页面上，从而破坏页面的外观。 Netscape 联合 Mosaic 拿出了一个解决方案，对不支持 JavaScript 的浏览器隐藏嵌入的 JavaScript 代码。最终方案是把脚本代码包含在一个 HTML 注释中

```js
<script><!-- 
function sayHi(){ 
  console.log("Hi!"); 
} 
//--></script>
```

使用这种格式，Mosaic 等浏览器就可以忽略 `<script>` 标签中的内容，而支持 JavaScript 的浏览器 则必须识别这种模式，将其中的内容作为 JavaScript 来解析

## 2.2 行内代码与外部文件

虽然可以直接在 HTML 文件中嵌入 JavaScript 代码，但通常认为最佳实践是尽可能将 JavaScript 代码放在外部文件中。不过这个最佳实践并不是明确的强制性规则。推荐使用外部文件的理由如下。
1. 可维护性。JavaScript 代码如果分散到很多 HTML 页面，会导致维护困难。而用一个目录保存所有 JavaScript 文件，则更容易维护，这样开发者就可以独立于使用它们的 HTML 页面来编辑代码。 
2. 缓存。浏览器会根据特定的设置缓存所有外部链接的 JavaScript 文件，这意味着如果两个页面都用到同一个文件，则该文件只需下载一次。这最终意味着页面加载更快。 
3. 适应未来。通过把 JavaScript 放到外部文件中，就不必考虑用 XHTML 或前面提到的注释黑科技。 包含外部 JavaScript 文件的语法在 HTML 和 XHTML 中是一样的。

## 2.3 文档模式

最初的文档模式有两种: 混杂 模式(quirks mode)和标准模式(standards mode)。可以使用 doctype 切换文档模式。

随着浏览器的普遍实现，又出现了第三种文档模式: 准标准模式(almost standards mode)。这种模式下的浏览器支持很多标准的特性，但是没有标准规定得那么严格。

## 2.4 `<noscript>` 元素

针对对早期浏览器不支持 JavaScript 的问题，需要一个页面优雅降级的处理方案。最终，`<noscript>`
元素出现，被用于给不支持 JavaScript 的浏览器提供替代内容。虽然如今的浏览器已经 100% 支持
JavaScript，但对于禁用 JavaScript 的浏览器来说，这个元素̮然有它的用处。

`<noscript>` 元素可以包含任何可以出现在 `<body>` 中的 HTML 元素，`<script>` 除外。在下列两种情况下，浏览器将显示包含在 `<noscript>` 中的内容：
1. 浏览器不支持脚本；
2. 浏览器对脚本的支持被关闭。